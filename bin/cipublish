#!/bin/bash

set -e

if [[ ${CODEBUILD_BUILD_SUCCEEDING} -eq 1 ]]
then
  git clone https://${GITHUB_TOKEN}@github.com/${GITHUB_USER}/ddcp.git tmp
  cd tmp && git fetch && git reset --hard ${CODEBUILD_RESOLVED_SOURCE_VERSION} && cd ..
  mv tmp/.git .git
  rm -rf tmp
  # is head tagged? if so, we're done.
  if [[ "$(git tag --contains HEAD)" == "" ]]
  then
    git config user.email "ci@chelseau.com"
    git config user.name "DDCP CI"
    echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    npx lerna publish ${BUILD_VERSION} --no-push --yes | tee /tmp/publish-results && grep -qv "lerna ERR\|WARN" < /tmp/publish-results
    # separate commands because we want our tag to push even if we've fallen behind master.
    git push origin v${BUILD_VERSION}
    git push origin master
  fi
fi
