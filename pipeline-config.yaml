Pipelines:
  - Name: ddcp-build
    Orchestrator: CodePipeline
    Sources:
      - Name: Source
        Type: CodeCommit
        RepositoryName: ddcp
        BranchName: master
    Stages:
      - Name: BuildStage
        Actions:
          - Name: Build
            Type: CodeBuild
            Order: 1
            SourceName: Source
            BuildSpec:
              Alias: BuildSpec
              Inline:
                version: 0.2
                phases:
                  install:
                    runtime-versions:
                      nodejs: 10
                      ruby: 2.6
                      python: 3.7
                    commands:
                      - gem install cfn-nag
                      - pip install cfn-lint
                      - npm install
                      - npx --no-install lerna bootstrap
                  build:
                    commands:
                      - npx --no-install lerna run lint
                      - npx --no-install lerna run build
                      - npx --no-install lerna run pack
                  post_build:
                    commands:
                      - npx --no-install lerna run cfn-lint
                artifacts:
                  secondary-artifacts:
                    Manager:
                      files:
                        - packages/manager/dist/manager.yaml
                      discard-paths: yes
                    Synthesizer:
                      files:
                        - packages/synthesizer/dist/@ddcpsynthesizer.zip
                      discard-paths: yes
      - Name: PublishStage
        Actions:
          - Name: Manager
            Type: S3Publish
            Order: 1
            SourceName: Manager
            Extract: true
            BucketArn:
              '!Import': PublicBucketArn
            AccessControl: PublicRead
            CacheControl:
              - max-age: 86400
          - Name: Synthesizer
            Type: S3Publish
            Order: 1
            SourceName: Synthesizer
            Extract: true
            BucketArn:
              '!Import': PrivateBucketArn
  - Name: ddcp-branch-build
    Orchestrator: CloudWatch
    Sources:
      - Name: Source
        Type: CodeCommit
        RepositoryName: ddcp
        NotBranchName: master
    Stages:
      - Name: BuildStage
        Actions:
          - Name: Build
            Type: CodeBuild
            Order: 1
            SourceName: Source
            BuildSpec:
              Inline:
                version:
                  '!Path':
                    '!Join':
                      - '!PathForAlias': BuildSpec
                      - - Inline
                        - version
                phases:
                  '!Path':
                    '!Join':
                      - '!PathForAlias': BuildSpec
                      - - Inline
                        - phases
